<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <!-- <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    /> -->
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <link
      href="https://fonts.googleapis.com/css2?family=Quicksand&display=swap"
      rel="stylesheet"
    />

    <link
      href="https://fonts.googleapis.com/css2?family=Dancing+Script&family=Quicksand&display=swap"
      rel="stylesheet"
    />
    <!-- Google Fonts -->

    <link rel="stylesheet" href="CSS files/googleFont.css" />
    <link rel="stylesheet" href="CSS files/account.css" />
    <link rel="stylesheet" href="CSS files/cart.css" />
    <link rel="stylesheet" href="CSS files/loginForm.css" />
    <link rel="stylesheet" href="CSS files/header.css" />
  </head>
  <body>
    <!-- header -->
    <div class="header_containor">
      <div id="header-placeholder"></div>
    </div>
    <!-- header -->

    <div class="account_container">
      <div class="left_side_options_container">
        <div class="left_side_options">
          <div class="my_orders">
            <div class="left_side_img">
              <img src="Photos/account/left_icons/shopping-bag 1.png" alt="" />
            </div>
            <div class="text">
              <h2>My Orders</h2>
              <span>View and tract your orders</span>
            </div>
          </div>
          <div class="cart">
            <div class="left_side_img">
              <img src="Photos/account/left_icons/shopping-cart 1.png" alt="" />
            </div>
            <div class="text">
              <h2>Cart</h2>
              <span>Manage your cart</span>
            </div>
          </div>
          <div class="profile">
            <div class="left_side_img">
              <img src="Photos/account/left_icons/user 2.png" alt="" />
            </div>
            <div class="text">
              <h2>Profile</h2>
              <span>Manage your account info</span>
            </div>
          </div>
        </div>
      </div>

      <div class="right_side_options">
        <!-- Account Details -->
        <div class="account_details_container">
          <div class="account_deital_heading">Account Details</div>
          <hr />
          <div class="account_details">
            <h2>Name</h2>
            <span id="user_name">User Name</span>
            <div class="edit"><span class="edit_pop1">EDIT</span></div>

            <h2>Email</h2>
            <span id="user_email">User Email Address</span>
            <div class="edit"><span class="edit_pop2">EDIT</span></div>

            <h2>Password</h2>
            <span id="user_password">********</span>
            <div class="edit"><span class="edit_pop3">EDIT</span></div>

            <h2>Birthday</h2>
            <span id="user_DOB"
              >We'd love to celebrate you with a little gift!</span
            >
            <div class="edit"><span class="edit_pop4">ADD</span></div>

            <h2>Skin Type</h2>
            <span id="user_skinType">We'll tailor a ritual just for you</span>
            <div class="edit"><span class="edit_pop5">ADD</span></div>
          </div>
          <div class="delete_logout">
            <div id="deleteUserButton">Delete Account?</div>
            <div id="logoutButton">
              <input
                type="button"
                value="LOG OUT"
                onmouseover="changeColor(this)"
                onmouseout="restoreOriginalColors(this)"
                onclick="logoutUser()"
              />
            </div>
          </div>
        </div>

        <div class="edit_popup">
          <!-- name -->
          <div class="name_edit pop1">
            <div class="edit_close close_pop1">
              <i class="fa-solid fa-xmark"></i>
            </div>
            <h2 class="name">Name</h2>
            <form action="/update-name" method="post" id="nameEditForm">
              <input
                type="text"
                class="name"
                placeholder="First Name"
                id="firstNameInput"
                required
                pattern="[A-Za-z\s]{2,50}"
                title="First name should contain only alphabets and be 2 to 50 characters long"
              />
              <input
                type="text"
                class="name"
                placeholder="Last Name"
                id="lastNameInput"
                required
                pattern="[A-Za-z\s]{2,50}"
                title="Last name should contain only alphabets and be 2 to 50 characters long"
              />
            </form>
            <div class="cancel_save">
              <span class="cancel" onclick="hidePopup('pop1')">CANCEL</span>
              <span class="save" onclick="submitForm('nameEditForm')"
                >SAVE</span
              >
            </div>
          </div>

          <!-- email -->
          <div class="name_edit pop2">
            <div class="edit_close close_pop2">
              <i class="fa-solid fa-xmark"></i>
            </div>
            <h2 class="name">Email</h2>
            <form action="/update-email" method="post" id="emailEditForm">
              <input
                type="email"
                class="name"
                id="new_email"
                placeholder="Enter New Email"
                required
              />
            </form>
            <div class="cancel_save">
              <span class="cancel" onclick="hidePopup('pop2')">CANCEL</span
              ><span class="save" onclick="submitEmailForm('emailEditForm')"
                >SAVE</span
              >
            </div>
          </div>

          <!-- password -->
          <div class="name_edit pop3">
            <div class="edit_close close_pop3">
              <i class="fa-solid fa-xmark"></i>
            </div>
            <h2 class="name">Password</h2>
            <form action="/update-password" method="post" id="passwordEditForm">
              <input
                type="password"
                class="name"
                id="previous_password"
                placeholder="Previous Password"
                required 
                pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z])(?=.*[@$!%*?&#])[A-Za-z\d@$!%*?&#]{8,}"
                title="Password must be at least 8 characters long and include one uppercase letter, one lowercase letter, one number, and one special character."               
              />
              <input
                type="password"
                class="name"
                id="new_password"
                placeholder="New Password"
                required 
                pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z])(?=.*[@$!%*?&#])[A-Za-z\d@$!%*?&#]{8,}"
                title="Password must be at least 8 characters long and include one uppercase letter, one lowercase letter, one number, and one special character."               
              />
            </form>
            <div class="cancel_save">
              <span class="cancel" onclick="hidePopup('pop3')">CANCEL</span
              ><span class="save" onclick="updatePassword()">SAVE</span>
            </div>
          </div>

          <!-- Birthday -->
          <div class="name_edit pop4">
            <div class="edit_close close_pop4">
              <i class="fa-solid fa-xmark"></i>
            </div>
            <h2 class="name">Date of Birth</h2>
            <form action="/update-dob" method="post" id="birthdayEditForm">
              <input
                type="date"
                class="name"
                name="dob"
                id="dobInput"
                placeholder="DOB"
                required
              />
            </form>
            <div class="cancel_save">
              <span class="cancel" onclick="hidePopup('pop4')">CANCEL</span
              ><span class="save" onclick="updateBirthday()">SAVE</span>
            </div>
          </div>

          <!-- Skin Type -->
          <div class="name_edit pop5">
            <div class="edit_close close_pop5">
              <i class="fa-solid fa-xmark"></i>
            </div>
            <h2 class="name">Skin-Type</h2>
            <form action="" method="post" id="skinTypeEditForm">
              <div
                class="q2_dry"
                onmouseover="changeColor(this)"
                onclick="changeColorsClick(this)"
                onmouseout="restoreOriginalColors(this)"
              >
                Dry
              </div>
              <div
                class="q2_oily"
                onmouseover="changeColor(this)"
                onclick="changeColorsClick(this)"
                onmouseout="restoreOriginalColors(this)"
              >
                Oily
              </div>
              <div
                class="q2_normal"
                onmouseover="changeColor(this)"
                onclick="changeColorsClick(this)"
                onmouseout="restoreOriginalColors(this)"
              >
                Normal
              </div>
            </form>
            <div class="cancel_save">
              <span class="cancel" onclick="hidePopup('pop5')">CANCEL</span
              ><span class="save" onclick="saveSkinType()">SAVE</span>
            </div>
          </div>
        </div>
        <!-- Account Details -->

        <!-- My Orders -->
        <div class="my_orders_container">
          <div class="my_orders_heading">My Orders</div>
          <hr />
          <ul class="myOrderProducts"></ul>
        </div>
        <!-- My Orders -->

        <!-- Cart -->
        <div class="my_cart_container">
          <div class="my_cart_heading">My Cart Products</div>
          <hr />
          <ul class="myCartProducts"></ul>
        </div>
        <!-- Cart -->
      </div>
    </div>

    <!-- Footer -->
    <div class="footer_container">
      <div id="footer-placeholder"></div>
    </div>
    <!-- Footer -->

    <script src="JavaScript files/account_option_selector.js"></script>
    <script src="JavaScript files/NavbarFooterLoader.js"></script>
    <script src="JavaScript files/loginButtonChanger.js"></script>
    <script src="JavaScript files/cart.js"></script>
    <script src="JavaScript files/addToCart.js"></script>
    <script src="JavaScript files/deleteAccount.js"></script>

    <!-- pop up hide -->
    <script>
      function hidePopup(popId) {
        var popup = document.querySelector("." + popId);
        if (popup) {
          popup.style.display = "none";
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        // Function to show the specified pop-up div and hide others
        function showPopup(popId) {
          var popups = document.querySelectorAll(".name_edit");
          popups.forEach(function (popup) {
            popup.style.display = "none";
          });

          var popup = document.querySelector("." + popId);
          if (popup) {
            popup.style.display = "block";
          }
        }

        document
          .querySelector(".edit_pop1")
          .addEventListener("click", function () {
            showPopup("pop1");
          });

        document
          .querySelector(".close_pop1")
          .addEventListener("click", function () {
            hidePopup("pop1");
          });

        document
          .querySelector(".edit_pop2")
          .addEventListener("click", function () {
            showPopup("pop2");
          });

        document
          .querySelector(".close_pop2")
          .addEventListener("click", function () {
            hidePopup("pop2");
          });

        document
          .querySelector(".edit_pop3")
          .addEventListener("click", function () {
            showPopup("pop3");
          });

        document
          .querySelector(".close_pop3")
          .addEventListener("click", function () {
            hidePopup("pop3");
          });

        document
          .querySelector(".edit_pop4")
          .addEventListener("click", function () {
            showPopup("pop4");
          });

        document
          .querySelector(".close_pop4")
          .addEventListener("click", function () {
            hidePopup("pop4");
          });

        document
          .querySelector(".edit_pop5")
          .addEventListener("click", function () {
            showPopup("pop5");
          });

        document
          .querySelector(".close_pop5")
          .addEventListener("click", function () {
            hidePopup("pop5");
          });
      });
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Fetch user details
        fetch("/user_detail")
          .then((response) => response.json())
          .then((data) => {
            updateDetails(data.userDetails);            
          })
          .catch((error) =>
            console.error("Error checking authentication:", error)
          );

        // Function to update the details in the HTML
        function updateDetails(userDetails) {
          updateDetail(
            "user_name",
            `${userDetails.first_name} ${userDetails.last_name}`
          );
          updateDetail("user_email", userDetails.email);
          updateDetail(
            "user_DOB",
            formatBirthday(userDetails.birthday) ||
              "We'd love to celebrate you with a little gift!"
          );

          updateDetail(
            "user_skinType",
            userDetails.skin_type || "We'll tailor a ritual just for you"
          );

          // Populate the input fields in the pop-up with current name
          document.getElementById("firstNameInput").value =
            userDetails.first_name;
          document.getElementById("lastNameInput").value =
            userDetails.last_name;
        }

        function formatBirthday(birthday) {
          if (birthday) {
            const date = new Date(birthday);
            return date.toLocaleDateString();
          }
          return null;
        }

        function updateDetail(elementId, value) {
          const detailElement = document.getElementById(elementId);
          if (detailElement) {
            detailElement.textContent = value;
          }
        }
      });

      // Function to handle form submissions
      function submitForm(formId) {
        const firstNameInput = document.getElementById("firstNameInput");
        const lastNameInput = document.getElementById("lastNameInput");

        const firstName = firstNameInput.value;
        const lastName = lastNameInput.value;

        if (!firstName || !lastName) {
          alert("Please enter both first name and last name");
          return;
        }

        fetch("/update-name", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            firstName: firstName,
            lastName: lastName,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert("Name updated successfully!");
              window.location.reload();
            } else {
              alert("Error updating name");
            }
          })
          .catch((error) => console.error("Error updating name:", error));
      }

      function submitEmailForm(formId) {
        const newEmail = document.getElementById("new_email").value;

        fetch("/update-email", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ newEmail }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert("Email updated successfully");
              window.location.reload();
            } else {
              alert("Error updating email");
            }
          })
          .catch((error) => console.error("Error updating email:", error));
      }

      // Function to handle password form submission
      function updatePassword() {
        const previousPassword =
          document.getElementById("previous_password").value;
        const newPassword = document.getElementById("new_password").value;

        // Send a fetch request to the server to update the password
        fetch("/update-password", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            previousPassword: previousPassword,
            newPassword: newPassword,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert("Password updated successfully!");
              window.location.reload();
            } else {
              alert(
                "Failed to update password. Please check your input and try again."
              );
            }
          })
          .catch((error) => {
            console.error("Error updating password:", error);
            alert(
              "An error occurred while updating the password. Please try again later."
            );
          });
      }

      function updateBirthday() {
        // Get the date of birth value from the input field
        const dobInput = document.getElementById("dobInput");
        const newDob = dobInput.value;
        console.log(newDob);

        const options = {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ newDob }),
        };

        // Fetch to the server endpoint for updating DOB
        fetch("/update-dob", options)
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert("Date of birth added!");
              window.location.reload();
            } else {
              if (data.message === "Date of birth already added") {
                alert("Date of birth has already been added.");
              } else {
                console.error("Failed to update DOB.");
              }
            }
          })
          .catch((error) => {
            console.error("Error updating DOB:", error);
          });
      }
    </script>

    <!-- skinType update -->
    <script>
      let selectedSkinType = null;
      var clickedDiv = null;
      function changeColor(element) {
        if (element !== clickedDiv) {
          element.style.backgroundColor = "#fcc6e2";
          element.style.border = "0.1vw solid black";
        }
      }

      function changeColorsClick(div) {
        // Reset styles for the previously clicked div
        if (clickedDiv) {
          clickedDiv.style.backgroundColor = "whitesmoke";
          clickedDiv.style.border = "0.1vw solid black";
        }

        // Set styles for the clicked div
        div.style.backgroundColor = "#fcc6e2"; 
        div.style.color = "black"; 

        // Update the clickedDiv variable
        clickedDiv = div;

        //select div by skin type
        selectedSkinType = div.innerText;
      }
      function restoreOriginalColors(element) {        
        if (element !== clickedDiv) {
          element.style.backgroundColor = "white";
          element.style.border = "0.1vw solid black";
        }
      }

      function saveSkinType() {
        console.log("Selected Skin Type:", selectedSkinType);

        if(selectedSkinType == null){
        alert("Please select a skin-type")
        }else{
          const options = {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ skinType: selectedSkinType }),
        };
        fetch("/update-skin-type", options)
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert("Skin-Type Updated!");
              window.location.reload();
            } else {
              console.error("Failed to update skin type.");
            }
          })
          .catch((error) => {
            console.error("Error updating skin type:", error);
          });
          window.location.reload();
        }
     
      }
    </script>

    <!-- order and cart products -->
    <script>
      function getAddToCartForMyCartAccount() {
        fetch("/GetAddToCartProducts", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            // Update the review list in the UI
            const CartList = document.querySelector(".myCartProducts");
            if (data.success) {
              CartList.innerHTML = "";
              const cart = data.row;

              cart.forEach((cart_product) => {
                var buyProduct = [];
                var buy_product = {
                  img: cart_product.img_url.replace("other pages/", ""),
                  name: cart_product.product_name,
                  price: parseInt(cart_product.price, 10),
                  quantity: 1,
                  rating: cart_product.rating,
                  weight: cart_product.size,
                };
                buyProduct.push(buy_product);
                const listItem = document.createElement("li");
                listItem.innerHTML = `
                  <div class="cart_product_section">
                        <div class="cart_product_image">
                          <a href="Product_Page.html?productName=${
                            cart_product.product_name
                          }&price=${cart_product.price}&img=${
                  cart_product.img_url
                }&rating=${cart_product.rating}">
                            <img
                              class="CartProductImagAccounre"
                              src="${cart_product.img_url}"
                              alt=""
                          /></a>
                        </div>
                        <div class="cart_product_name">${
                          cart_product.product_name
                        }</div>
                        <div class="cart_product_rating">${generateStarsForAccount(
                          cart_product.rating
                        )}</div>
                        <div class="cart_product_price">Price : ${parseInt(
                          cart_product.price
                        )}</div>
                        <a href="paymentPage.html?product=${encodeURIComponent(
                          JSON.stringify(buyProduct)
                        )}"
                          ><div
                            class="cart_product_buttons"
                            onmouseover="changeColor(this)"            
                            onmouseout="restoreOriginalColors(this)"
                          >
                            Buy
                          </div></a
                        >
                      </div>
                `;
                CartList.appendChild(listItem);
              });
              var currentPath = window.location.pathname;
              if (currentPath.includes("other%20pages")) {
                const images = document.querySelectorAll(
                  ".CartProductImagAccounre"
                );
                images.forEach((image) => {
                  image.src = image.src.replace("other%20pages", "");
                });
              }
            }
          })
          .catch((error) => {
            console.error("Error updating review list:", error);
          });
      }
      getAddToCartForMyCartAccount();

      //My order
      function getPurchaseForMyOrdersAccount() {
        fetch("/getUserPurchaseProducts", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            // Update the review list in the UI
            const OrderList = document.querySelector(".myOrderProducts");
            if (data.success) {
              OrderList.innerHTML = "";
              const Orders = data.row;

              Orders.forEach((MyOrders) => {
                const listItem = document.createElement("li");

                var purchase_Date = MyOrders.purchase_date;
                var purchaseDate = new Date(purchase_Date);
                purchaseDate.setDate(purchaseDate.getDate() + 5);
                var day = ("0" + purchaseDate.getDate()).slice(-2); // Get day with leading zero if necessary
                var month = ("0" + (purchaseDate.getMonth() + 1)).slice(-2); // Get month with leading zero if necessary
                var year = purchaseDate.getFullYear();

                var formattedDate = day + "-" + month + "-" + year;
                console.log(MyOrders.purchase_date);
                console.log(formattedDate);

                listItem.innerHTML = `
                 <div class="my_product_orders">
                <div class="produce_img">
                  <img
                    src="${MyOrders.produc_img}"
                    alt=""
                  />
                </div>
                <div class="product_name_rating">
                  <div class="product_name">${MyOrders.product_Name}</div>
                  <div class="product_rating">${generateStarsForAccount(
                    MyOrders.rating
                  )}</div>
                </div>
                <div class="product_weight_qty">
                  <div class="weight">Weight : ${MyOrders.size}</div>
                  <div class="qty">Quantity : ${MyOrders.quantity}</div>
                </div>
                <div class="price_date">
                  <div class="price">Price : â‚¹${MyOrders.price}</div>
                  <dive class="Purchase_date">Delivery Date : ${formattedDate}</div>
                </div>
              </div>
                `;
                OrderList.appendChild(listItem);
              });
            }
          })
          .catch((error) => {
            console.error("Error updating review list:", error);
          });
      }
      getPurchaseForMyOrdersAccount();
      function generateStarsForAccount(rating) {
        const starHtml = Array.from({ length: rating }, () => {
          return `<img class="reviesStarsAccount" src="Photos/Stars/active-star.png" alt="" />`;
        });
        return starHtml.join("");
      }
    </script>
    <!-- logout  -->
    <script>
      // Function to handle user logout
      function logoutUser() {
        fetch("/logout")
          .then((response) => response.json())
          .then((data) => {
            if (data.message === "Logged out successfully") {
              alert("You have been logged out!");
              window.location.href = "/Index.html";
            } else {
              alert("Error logging out");
            }
          })
          .catch((error) => console.error("Error logging out:", error));
      }
    </script>
  </body>
</html>
