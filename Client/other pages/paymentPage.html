<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <link
      href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Dancing+Script&family=Quicksand&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Alex+Brush&display=swap"
      rel="stylesheet"
    />

    <link
      href="https://fonts.googleapis.com/css2?family=Poppins&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Quicksand&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Muli&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Lato&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap"
      rel="stylesheet"
    />
    <!-- Google Fonts -->

    <link rel="stylesheet" href="CSS files/googleFont.css" />
    <link rel="stylesheet" href="CSS files/color.css" />
    <link rel="stylesheet" href="CSS files/paymentPage.css" />
    <link rel="stylesheet" href="CSS files/header.css" />
    <link rel="stylesheet" href="CSS files/loginForm.css" />
    <link rel="stylesheet" href="CSS files/cart.css" />
    <link rel="stylesheet" href="CSS files/word_spacing.css" />
  </head>
  <body>
    <!-- header -->
    <div class="header_containor">
      <div id="header-placeholder"></div>
    </div>
    <!-- header -->
    <div class="payment_products_container">
      <div class="userInfo_payment_container">
        <form action="" class="purchase_form">
          <div class="email_container">
            <div class="email_heading_container">
              <div class="contactHeading">Contact</div>
              <div class="logIn">
                Have an Account?
                <a href="#" onclick="toggleLoginForm()">Log In</a>
              </div>
            </div>
            <input
              type="email"
              placeholder="Email"
              id="purchaseUserEmail"
              required
            />
            <div class="emailMeNews">
              <input type="checkbox" /><span
                >Email me with news and offers</span
              >
            </div>
          </div>
          <div class="deviveryDetails_container">
            <div class="delivery_heading">Delivery</div>
            <div class="country">
              <input
                type="text"
                id="UserCountry"
                placeholder="Country Region"
                required
              />
            </div>
            <div class="name">
              <input
                type="text"
                id="UserFirstName"
                placeholder="First Name"
                required
                pattern="[A-Za-z\s]{2,50}"
                title="First name should contain only alphabets and be 2 to 50 characters long"
              />
              <input
                type="text"
                id="UserLastName"
                placeholder="Last Name"
                required
                pattern="[A-Za-z\s]{2,50}"
                title="First name should contain only alphabets and be 2 to 50 characters long"
              />
            </div>
            <div class="address">
              <input
                type="text"
                id="UserAddress"
                placeholder="Address"
                required
              />
            </div>
            <div class="city_state_pincode">
              <input type="text" id="UserCity" placeholder="City" required />
              <input type="text" id="UserState" placeholder="State" required />
              <input
                type="number"
                id="UserPincode"
                placeholder="Pincode"
                required
              />
            </div>
            <div class="phoneNumber">
              <input
                type="tel"
                id="UserPhoneNumber"
                placeholder="Phone"
                required
                pattern="[0-9]{10}"
                title="Phone number must be 10 digits long."
              />
            </div>
            <div class="saveInfo">
              <input type="checkbox" id="saveInfo" /><span
                >Save this information for next time</span
              >
            </div>
          </div>
          <div class="payment_container">
            <div class="payment_heading">Payment</div>
            <div class="payment_subHeading">
              All transaction are secure and encrypted
            </div>
            <div class="onlinePayment">
              <input
                type="radio"
                name="paymentMethod"
                checked
                value="Online"
                id="onlinePaymentRadio"
              />
              <span>UPI/ Cards, Wallets, NetBanking</span>
            </div>
            <div class="onlinePaymentWarning">
              <img src="Photos/payment/credit-card.png" alt="" />
              <span
                >After clicking “Pay now”, you will be redirect to Secure (UPI,
                Cards, Wallet, NetBanking) to complete your purchase
                securely.</span
              >
            </div>
            <div class="cashOnDelivery">
              <input
                type="radio"
                id="codRadio"
                name="paymentMethod"
                value="COD"
              /><span>Cash on Delivery (COD)</span>
            </div>
          </div>
          <div class="billingAddress_conatiner">
            <div class="billing_heading">Billing address</div>
            <div class="sameAsShippingAdd">
              <input
                type="radio"
                name="BillingAddress"
                checked
                value="sameAddress"
                id="billingRadioSameAddress"
              /><span>Same as shipping address</span>
            </div>
            <div class="diffAddress">
              <input
                type="radio"
                name="BillingAddress"
                value="DiiffrentAddress"
                id="billingRadioDiffAddress"
              />
              <span>Use a different billing adress</span>
            </div>
            <div class="differentAdd_container">
              <div class="diff_country">
                <input
                  type="text"
                  id="diifCountry"
                  placeholder="Country Region"
                  required
                />
              </div>
              <div class="diff_name">
                <input
                  type="text"
                  id="diffFirstName"
                  placeholder="firstName"
                  required
                  pattern="[A-Za-z\s]{2,50}"
                  title="First name should contain only alphabets and be 2 to 50 characters long"
                />
                <input
                  type="text"
                  id="diffLalsName"
                  placeholder="lastName"
                  required
                  pattern="[A-Za-z\s]{2,50}"
                  title="First name should contain only alphabets and be 2 to 50 characters long"
                />
              </div>
              <div class="diff_address">
                <input
                  type="text"
                  id="diffAddress"
                  placeholder="Address"
                  required
                />
              </div>
              <div class="diff_city_state_pincode">
                <input type="text" id="diffCity" placeholder="city" required />
                <input
                  type="text"
                  id="diffState"
                  placeholder="state"
                  required
                />
                <input
                  type="number"
                  id="diffPincode"
                  placeholder="pincode"
                  required
                />
              </div>
              <div class="diff_phoneNumber">
                <input
                  type="tel"
                  id="diffPhoneNumber"
                  placeholder="Phone"
                  required
                  pattern="[0-9]{10}"
                  title="Phone number must be 10 digits long."
                />
              </div>
            </div>
            <div class="payNow_container">
              <!-- <button type="submit">Pay Now</button> -->
              <input type="submit" value="Pay Now" />
            </div>
          </div>
        </form>
      </div>

      <div class="allProducts_container">
        <ul class="purchaseProducts_container"></ul>
        <div class="subTotal_contianer">
          <div class="subTotal">Sub Total</div>
          <div class="subTotalAmount">xyz</div>
        </div>
        <div class="gst_container">
          <div class="GST">Include GST</div>
          <div class="gstAmount">xyz</div>
        </div>
        <div class="totalAmount_continer">
          <div class="total">Total</div>
          <div class="totalAmount">xyz</div>
        </div>
      </div>
    </div>
    <!-- Footer -->
    <div class="footer_container">
      <div id="footer-placeholder"></div>
    </div>
    <!-- Footer -->
    <script src="JavaScript files/NavbarFooterLoader.js"></script>
    <script src="JavaScript files/cart.js"></script>
    <script src="JavaScript files/loginFormShow.js"></script>
    <script src="JavaScript files/singIn.js"></script>
    <script src="JavaScript files/addToCart.js"></script>
    <script>
      checkAuthAndFillUserInfo();
      var urlParams = new URLSearchParams(window.location.search);
      var products = urlParams.get("product");
      var productsArray = JSON.parse(decodeURIComponent(products));

      const purchaseProductsList = document.querySelector(
        ".purchaseProducts_container"
      );
      var subTotal = 0;
      const productList = [];
      productsArray.forEach((item) => {
        const listItem = document.createElement("li");
        listItem.innerHTML = `
                    <div class="productToPurchase">
              <div class="buying_produce_img">
                <img
                  src="${item.img}"
                  alt=""
                />
              </div>

              <div class="buying_product_name_star">
                <div class="buying_product_name">${item.name}</div>
                <div class="star">${generateStarsForIndexPage(
                  item.rating
                )}</div>
              </div>

              <div class="buying_product_qty">
                <div class="weight_container">
                  <div class="weight">Weight : ${item.weight}</div>
                </div>
                <div class="quantity_container">
                  <div class="quantity">Qty : </div>
                  <span class="qty_number">${item.quantity}</span>
                </div>
              </div>

              <div class="buying_product_price">
                <div class="buying_price">&#8377; ${item.price}</div>
              </div>
            </div>
                  `;
        purchaseProductsList.appendChild(listItem);
        subTotal += item.price;
        var product = {
          name: item.name,
          img: item.img,
          size: item.weight,
          qty: item.quantity,
          price: item.price,
        };
        productList.push(product);

        function generateStarsForIndexPage(rating) {
          const starHtml = Array.from({ length: rating }, () => {
            return `<img class="IndexPageStars" src="Photos/Stars/active-star.png" alt="" />`;
          });
          return starHtml.join("");
        }
      });
      productList.forEach((item) => {
        console.log(item.name);
      });

      subTotal = parseInt(subTotal);

      document.querySelector(
        ".subTotalAmount"
      ).innerHTML = `&#8377; ${subTotal} `;
      var subTotalGST = (subTotal * 18) / 100;

      document.querySelector(
        ".gstAmount"
      ).innerHTML = `+ &#8377; ${subTotalGST}`;
      document.querySelector(".totalAmount").innerHTML = `&#8377; ${
        subTotal + subTotalGST
      }`;
      var totalAmount = subTotal + subTotalGST;

      var saveInfo = document.getElementById("saveInfo");

      //submiting
      document.addEventListener("DOMContentLoaded", () => {
        const form = document.querySelector(".purchase_form");
        form.addEventListener("submit", (event) => {
          event.preventDefault();

          fetch("/purchase", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              email: document.getElementById("purchaseUserEmail").value,
              country: document.getElementById("UserCountry").value,
              fname: document.getElementById("UserFirstName").value,
              lname: document.getElementById("UserLastName").value,
              address: document.getElementById("UserAddress").value,
              city: document.getElementById("UserCity").value,
              state: document.getElementById("UserState").value,
              pincode: document.getElementById("UserPincode").value,
              phone: document.getElementById("UserPhoneNumber").value,
              paymentMethod: document.querySelector(
                'input[name="paymentMethod"]:checked'
              ).value,
              billingAddress: document.querySelector(
                'input[name="BillingAddress"]:checked'
              ).value,
              diffcountry: document.getElementById("diifCountry").value,
              difffname: document.getElementById("diffFirstName").value,
              difflname: document.getElementById("diffLalsName").value,
              diffaddress: document.getElementById("diffAddress").value,
              diffcity: document.getElementById("diffCity").value,
              diffstate: document.getElementById("diffState").value,
              diffpincode: document.getElementById("diffPincode").value,
              diffphone: document.getElementById("diffPhoneNumber").value,
              amount: totalAmount,
              productList: productList,
              saveInfo: saveInfo.checked,
            }),
          })
            .then((response) => {
              if (response.status === 401) {
                return response.json();
              }
              if (!response.ok) {
                throw new Error("Network response was not ok");
              }
              return response.json();
            })
            .then((data) => {
              if (data.message === "account already exits on this email") {
                alert("user already exixst");
              }
              if (data.message === "Purchase successful") {
                alert("Purchase successful");
                window.location.href = "/Index.html";
              }
            })
            .catch((error) => {
              console.error("Fetch error:", error);
            });
        });
      });

      function checkAuthAndFillUserInfo() {
        window.addEventListener("load", function () {
          fetch("/checkAuth")
            .then((response) => {
              if (!response.ok) {
                throw new Error("Failed to check authentication");
              }
              return response.json();
            })
            .then((data) => {
              if (data.isAuthenticated) {
                return fetch("/user_detail");
              } else {
                console.log("user is not logged in");
              }
            })
            .then((response) => {
              if (!response) {
                console.log("Unable to find user details");
              } else {
                return response.json();
              }
            })
            .then((userData) => {
              if (userData) {
                // Autofill email input field
                document.getElementById("purchaseUserEmail").value =
                  userData.userDetails.email;

                // Make email field read-only
                document.getElementById("purchaseUserEmail").readOnly = true;

                autoFillUserDetails();
              }
            })
            .catch((error) => {
              console.error("Error:", error);
            });
        });
      }
      function autoFillUserDetails() {
        fetch(`/getUserAddressInfo`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())

          .then((data) => {
            if (data.success == true) {
              const user_Adress = data.row;
              document.getElementById("UserCountry").value =
                user_Adress[0].country_region;
              document.getElementById("UserFirstName").value =
                user_Adress[0].first_name;
              document.getElementById("UserLastName").value =
                user_Adress[0].last_name;
              document.getElementById("UserAddress").value =
                user_Adress[0].address;
              document.getElementById("UserCity").value = user_Adress[0].city;
              document.getElementById("UserState").value = user_Adress[0].state;
              document.getElementById("UserPincode").value =
                user_Adress[0].pincode;
              document.getElementById("UserPhoneNumber").value =
                user_Adress[0].phone_number;
            }
          })
          .catch((error) => {
            console.error("Not getting save address:", error);
          });
      }
    </script>
    <script>
      const onlinePaymentRadio = document.getElementById("onlinePaymentRadio");
      const codRadio = document.getElementById("codRadio");
      const onlinePaymentWarning = document.querySelector(
        ".onlinePaymentWarning"
      );
      onlinePaymentRadio.addEventListener("change", () => {
        onlinePaymentWarning.style.display = onlinePaymentRadio.checked
          ? "flex"
          : "none";
      });

      codRadio.addEventListener("change", () => {
        onlinePaymentWarning.style.display = codRadio.checked ? "none" : "flex";
      });

      const billingRadioSameAddress = document.getElementById(
        "billingRadioSameAddress"
      );
      const billingRadioDiffAddress = document.getElementById(
        "billingRadioDiffAddress"
      );
      const differentAdd_container = document.querySelector(
        ".differentAdd_container"
      );
      const diffAddress = document.querySelector(".diffAddress");
      billingRadioDiffAddress.addEventListener("change", () => {
        const hiddenInputs = document.querySelectorAll(
          ".differentAdd_container input"
        );
        hiddenInputs.forEach((input) => {
          input.disabled = false;
        });
        differentAdd_container.style.display = billingRadioDiffAddress.checked
          ? "block"
          : "none";

        diffAddress.style.borderRadius = "0";
      });

      billingRadioSameAddress.addEventListener("change", () => {
        const hiddenInputs = document.querySelectorAll(
          ".differentAdd_container input"
        );
        hiddenInputs.forEach((input) => {
          input.disabled = true;
        });
        differentAdd_container.style.display = billingRadioSameAddress.checked
          ? "none"
          : "block";

        diffAddress.style.borderRadius = "0 0 0.5vw .5vw";
      });
      const hiddenInputs = document.querySelectorAll(
        ".differentAdd_container input"
      );
      hiddenInputs.forEach((input) => {
        input.disabled = true;
      });
    </script>
  </body>
</html>
